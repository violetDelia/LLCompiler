// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<4x6xcomplex<f64>> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %0:2 = call @inputs() : () -> (tensor<4x3xi32>, tensor<3x6xcomplex<f64>>)
    %1 = call @expected() : () -> tensor<4x6xcomplex<f64>>
    %2 = stablehlo.convert %0#0 : (tensor<4x3xi32>) -> tensor<4x3xcomplex<f64>>
    %3 = stablehlo.convert %0#1 : tensor<3x6xcomplex<f64>>
    %4 = stablehlo.dot_general %2, %3, contracting_dims = [1] x [0] : (tensor<4x3xcomplex<f64>>, tensor<3x6xcomplex<f64>>) -> tensor<4x6xcomplex<f64>>
    stablehlo.custom_call @check.expect_close(%4, %1) {has_side_effect = true} : (tensor<4x6xcomplex<f64>>, tensor<4x6xcomplex<f64>>) -> ()
    return %4 : tensor<4x6xcomplex<f64>>
  }
  func.func private @inputs() -> (tensor<4x3xi32> {mhlo.layout_mode = "default"}, tensor<3x6xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %c = stablehlo.constant dense<[[2, -2, 2], [-2, 0, -4], [-1, 2, 2], [1, 0, 5]]> : tensor<4x3xi32>
    %cst = stablehlo.constant dense<[[(5.94600281869117,0.86775521945853185), (1.0960862804538838,-3.5040876535195684), (0.063281084451759645,-0.46486191243139552), (3.5678471282468438,3.0990927856634003), (-1.8802277458020162,2.976133697670071), (-2.6564495670447634,1.5968353027323903)], [(1.5956357130343652,-5.5250709219034526), (-2.377085038189394,-0.62118447583251379), (3.3002022618902167,1.8004754804893524), (-1.8025804413586219,1.862281665610271), (0.20806517220524118,1.6704238019865381), (-1.8760310808329961,2.960222373280557)], [(-3.0070052096542872,-3.0711417558300207), (-2.1281845124734229,-0.44472585396313635), (-1.6632141381101371,-1.6981827168304848), (8.135348322284063,-4.3371886833674775), (3.206588453295792,3.4852145833792632), (-3.282033380898647,1.1998585226472611)]]> : tensor<3x6xcomplex<f64>>
    return %c, %cst : tensor<4x3xi32>, tensor<3x6xcomplex<f64>>
  }
  func.func private @expected() -> (tensor<4x6xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(2.6867237920050346,6.643368771063928), (2.6899736123397098,-6.6552580633003817), (-9.8002706310971881,-7.9270402195024658), (27.011551783779058,-6.200755126628696), (2.2365910705770693,9.5818489581255921), (-8.1249037342208296,-0.3270570958018113)], [(0.13601520123480881,10.549056584403019), (6.320565488985924,8.7870787228916818), (6.5262943835370288,7.7224546921847299), (-39.677087545629938,11.15056916214311), (-9.0658983215791356,-19.893125728857193), (18.441032657684115,-7.993104696053825)], [(-8.7687418119310134,-18.060180574925479), (-10.106625381779518,1.3722669939282681), (3.2106951631084,0.66944743974913035), (9.0976886336040383,-8.0489068211778125), (8.7095349968040825,7.3351430730615315), (-7.6596793564185228,6.7233264891232469)], [(-9.0890232295802669,-14.487953559691571), (-9.5448362819132306,-5.7277169233352501), (-8.2527896060989256,-8.9557754965838185), (44.244588739667158,-18.586850631173988), (14.152714520676945,20.402206614566389), (-19.066616471537998,7.5961279159686956)]]> : tensor<4x6xcomplex<f64>>
    return %cst : tensor<4x6xcomplex<f64>>
  }
}
